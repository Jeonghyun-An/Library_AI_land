version: "3.9"

x-ragnet-network: &ragnet
  networks:
    - library-ragnet

services:
  etcd:
    image: quay.io/coreos/etcd:v3.5.0
    container_name: library-etcd
    environment:
      ETCD_DATA_DIR: "/etcd"
      ETCD_AUTO_COMPACTION_RETENTION: "1"
      ETCD_QUOTA_BACKEND_BYTES: "4294967296"
      ETCD_SNAPSHOT_COUNT: "50000"
      ETCD_ENABLE_V2: "true"
      ETCD_LOG_LEVEL: "info"
      ETCD_LISTEN_CLIENT_URLS: "http://0.0.0.0:2379"
      ETCD_ADVERTISE_CLIENT_URLS: "http://etcd:2379"
      ETCD_LISTEN_PEER_URLS: "http://0.0.0.0:2380"
      ETCD_INITIAL_ADVERTISE_PEER_URLS: "http://etcd:2380"
      ETCD_INITIAL_CLUSTER: "default=http://etcd:2380"
      ETCD_NAME: "default"
      ETCDCTL_API: "3"
    volumes:
      - library_etcd_data:/etcd
    <<: *ragnet
    healthcheck:
      test:
        [
          "CMD",
          "etcdctl",
          "endpoint",
          "health",
          "--endpoints=http://127.0.0.1:2379",
        ]
      interval: 5s
      timeout: 3s
      retries: 15
      start_period: 20s
    restart: unless-stopped

  minio:
    image: minio/minio:latest
    container_name: library-minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_SECRET_KEY:-minioadmin}
    volumes:
      - library_minio_data:/data
    ports:
      - "19000:9000"
      - "19001:9001"
    <<: *ragnet
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:9000/minio/health/live"]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 20s
    restart: unless-stopped

  minio-init:
    image: minio/mc:latest
    container_name: library-minio-init
    <<: *ragnet
    depends_on:
      minio:
        condition: service_healthy
    environment:
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY:-minioadmin}
      MINIO_BUCKET: "library-bucket"
    entrypoint: ["/bin/sh", "-c"]
    command: >
      "
      mc alias set myminio http://minio:9000 $${MINIO_ACCESS_KEY} $${MINIO_SECRET_KEY} &&
      mc mb -p myminio/$${MINIO_BUCKET} || true &&
      mc anonymous set none myminio/$${MINIO_BUCKET} || true &&
      echo '[minio-init] bucket ensured: ' $${MINIO_BUCKET}
      "
    restart: "no"

  milvus:
    image: milvusdb/milvus:v2.2.11
    container_name: library-milvus
    command: ["milvus", "run", "standalone"]
    environment:
      ETCD_ENDPOINTS: "etcd:2379"
      MINIO_ADDRESS: "minio:9000"
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY:-minioadmin}
      MINIO_USE_SSL: "false"
      MINIO_BUCKET_NAME: "library-bucket"
    volumes:
      - library_milvus_data:/var/lib/milvus
    depends_on:
      etcd:
        condition: service_healthy
      minio:
        condition: service_healthy
      minio-init:
        condition: service_completed_successfully
    <<: *ragnet
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:9091/healthz"]
      interval: 10s
      timeout: 5s
      retries: 60
      start_period: 300s
    restart: unless-stopped

  vllm:
    image: vllm/vllm-openai:latest-cu130
    container_name: library-vllm
    <<: *ragnet
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all # ← H200 전체 인식
              capabilities: ["gpu"]
    shm_size: "32g" # ← 32B 모델은 16g로 부족할 수 있음
    environment:
      HUGGINGFACE_HUB_TOKEN: ${HUGGINGFACE_TOKEN}
      HF_TOKEN: ${HUGGINGFACE_TOKEN}
      HF_HOME: "/models"
      CUDA_VISIBLE_DEVICES: "0"
      NVIDIA_VISIBLE_DEVICES: "0"
      NVIDIA_DRIVER_CAPABILITIES: "compute,utility"
      TRANSFORMERS_OFFLINE: "0"
      VLLM_WORKER_MULTIPROC_METHOD: "spawn" # ← H200 multi-GPU 안정성
    volumes:
      - /data/models/.hf-cache:/models:rw
    command:
      - google/gemma-3-12b-it
      - --served-model-name
      - gemma-3-12b
      - --download-dir
      - /models
      - --max-model-len
      - "16384"
      - --dtype
      - bfloat16
      - --gpu-memory-utilization
      - "0.35"
      - --max-num-seqs
      - "4" # ← 여유있게
      - --host
      - "0.0.0.0"
      - --port
      - "8000"
      # enforce-eager 제거 → H200은 FlashAttention2 지원하므로 오히려 느려짐
    ports:
      - "18080:8000"
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://127.0.0.1:8000/v1/models"]
      interval: 30s
      timeout: 10s
      retries: 40 # ← 32B 모델 로딩 시간 고려 (retries × interval = 최대 20분)
      start_period: 600s # ← 10분 유예 (다운로드 포함 시 더 늘려야 함)
    restart: unless-stopped

  fastapi:
    image: landsoftdocker/library-fastapi:latest
    container_name: library-fastapi
    <<: *ragnet
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all # ← gpus: all 대신 이걸로 통일
              capabilities: ["gpu"]
    environment:
      IS_DOCKER: "true"
      PYTHONUNBUFFERED: "1"
      CUDA_VISIBLE_DEVICES: "0"

      MINIO_ENDPOINT: "minio:9000"
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY:-minioadmin}
      MINIO_SECURE: "false"
      MINIO_BUCKET: "library-bucket"

      MILVUS_HOST: "milvus"
      MILVUS_PORT: "19530"
      MILVUS_COLLECTION: "library_books"

      VLLM_BASE_URL: "http://vllm:8000"
      VLLM_MODEL_FOR_SUMMARY: "gemma-3-12b"

      RAG_TARGET_TOKENS: "512"
      RAG_OVERLAP_TOKENS: "64"
      RAG_MIN_CHUNK_TOKENS: "100"
      RAG_TOPK_INIT: "40"
      RAG_SCORE_THRESHOLD: "0.3"
      RAG_CONTEXT_BUDGET_TOKENS: "2048"
      RAG_USE_HYBRID: "1"
      RAG_HYBRID_WEIGHT_VEC: "0.7"

      EMBEDDING_MODEL_NAME: "BAAI/bge-m3"
      EMBEDDING_BATCH_SIZE: "32"
      EMBEDDING_MAX_LENGTH: "512"

      RERANKER_MODEL_NAME: "BAAI/bge-reranker-v2-m3"
      RERANKER_BATCH_SIZE: "16"

      RAG_HYBRID_WEIGHT_DENSE: "0.5"
      RAG_HYBRID_WEIGHT_SPARSE: "0.3"
      RAG_HYBRID_WEIGHT_KEYWORD: "0.2"
    depends_on:
      milvus:
        condition: service_healthy
      minio:
        condition: service_healthy
      # vllm:
      # condition: service_healthy    # service_healthy는 vllm 뜨기 전에 fastapi 죽을 수 있음
    ports:
      - "18000:8000"
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 60s
    restart: unless-stopped

  nuxt:
    image: landsoftdocker/library-nuxt:latest
    container_name: library-nuxt
    <<: *ragnet
    environment:
      NUXT_PUBLIC_API_BASE: "/api"
      NITRO_HOST: "0.0.0.0"
      NITRO_PORT: "3000"
      PORT: "3000"
    depends_on:
      fastapi:
        condition: service_healthy
    restart: unless-stopped

  gateway:
    image: nginx:alpine
    container_name: library-gateway
    <<: *ragnet
    volumes:
      - /data/library-rag/runtime/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - /data/library-rag/runtime/nginx/conf.d:/etc/nginx/conf.d:ro
    ports:
      - "90:80"
    depends_on:
      - nuxt
      - fastapi
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://127.0.0.1/health"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 20s
    restart: unless-stopped

volumes:
  library_etcd_data:
    external: true
    name: library_etcd_data
  library_milvus_data:
    external: true
    name: library_milvus_data
  library_minio_data:
    external: true
    name: library_minio_data

networks:
  library-ragnet:
    external: true
    name: library-ragnet
