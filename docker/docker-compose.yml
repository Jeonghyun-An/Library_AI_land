# docker/docker-compose.yml
# 도서관 지식검색 RAG 시스템 (Mock → Linux(H200) 이관 고려)
# - external volume/network 사용
# - MinIO bucket 자동 생성(minio-init)
# - Milvus healthcheck 완화

x-ragnet-network: &ragnet
  networks:
    - library-ragnet

services:
  # ========== 메타데이터 저장소 (etcd) ==========
  etcd:
    image: quay.io/coreos/etcd:v3.5.0
    container_name: library-etcd
    environment:
      ETCD_DATA_DIR: "/etcd"
      ETCD_AUTO_COMPACTION_RETENTION: "1"
      ETCD_QUOTA_BACKEND_BYTES: "4294967296"
      ETCD_SNAPSHOT_COUNT: "50000"
      ETCD_ENABLE_V2: "true"
      ETCD_LOG_LEVEL: "info"
      ETCD_LISTEN_CLIENT_URLS: "http://0.0.0.0:2379"
      ETCD_ADVERTISE_CLIENT_URLS: "http://etcd:2379"
      ETCD_LISTEN_PEER_URLS: "http://0.0.0.0:2380"
      ETCD_INITIAL_ADVERTISE_PEER_URLS: "http://etcd:2380"
      ETCD_INITIAL_CLUSTER: "default=http://etcd:2380"
      ETCD_NAME: "default"
      ETCDCTL_API: "3"
    volumes:
      - library_etcd_data:/etcd
    <<: *ragnet
    healthcheck:
      test:
        [
          "CMD",
          "etcdctl",
          "endpoint",
          "health",
          "--endpoints=http://127.0.0.1:2379",
        ]
      interval: 5s
      timeout: 3s
      retries: 15
      start_period: 20s
    restart: unless-stopped

  # ========== 객체 저장소 (MinIO) ==========
  minio:
    image: minio/minio:latest
    container_name: library-minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_SECRET_KEY:-minioadmin}
    volumes:
      - library_minio_data:/data
    ports:
      - "9000:9000"
      - "9001:9001"
    <<: *ragnet
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:9000/minio/health/live"]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 20s
    restart: unless-stopped

  # ========== MinIO Bucket Init (library-bucket 자동 생성) ==========
  # - Milvus가 버킷 없어서 내부 컴포넌트(DataCoord) 꼬이는 걸 방지
  minio-init:
    image: minio/mc:latest
    container_name: library-minio-init
    <<: *ragnet
    depends_on:
      minio:
        condition: service_healthy
    environment:
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY:-minioadmin}
      MINIO_BUCKET: "library-bucket"
    entrypoint: ["/bin/sh", "-c"]
    command: >
      "
      mc alias set myminio http://minio:9000 $${MINIO_ACCESS_KEY} $${MINIO_SECRET_KEY} &&
      mc mb -p myminio/$${MINIO_BUCKET} || true &&
      mc anonymous set none myminio/$${MINIO_BUCKET} || true &&
      echo '[minio-init] bucket ensured: ' $${MINIO_BUCKET}
      "
    restart: "no"

  # ========== 벡터 데이터베이스 (Milvus) ==========
  milvus:
    image: milvusdb/milvus:v2.2.11
    container_name: library-milvus
    command: ["milvus", "run", "standalone"]
    environment:
      ETCD_ENDPOINTS: "etcd:2379"
      MINIO_ADDRESS: "minio:9000"
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY:-minioadmin}
      MINIO_USE_SSL: "false"
      MINIO_BUCKET_NAME: "library-bucket"
    volumes:
      - library_milvus_data:/var/lib/milvus
    depends_on:
      etcd:
        condition: service_healthy
      minio:
        condition: service_healthy
      minio-init:
        condition: service_completed_successfully
    <<: *ragnet
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:9091/healthz"]
      interval: 10s
      timeout: 5s
      retries: 60
      start_period: 300s
    restart: unless-stopped

  # ========== LLM 서버 (vLLM - A4000 최적화) ==========
  vllm-a4000:
    image: vllm/vllm-openai:latest
    container_name: library-vllm
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    <<: *ragnet
    environment:
      HUGGINGFACE_HUB_TOKEN: ${HUGGINGFACE_TOKEN}
      HF_TOKEN: ${HUGGINGFACE_TOKEN}
      HF_HOME: "/models"
      CUDA_VISIBLE_DEVICES: "0"
      TRANSFORMERS_OFFLINE: "0"
      VLLM_USE_FLASHINFER: "0"
    volumes:
      - ../models/.hf-cache:/models:rw
    command:
      - --model
      - google/gemma-3-4b-it
      - --served-model-name
      - gemma-3-4b-it
      - --download-dir
      - /models
      - --max-model-len
      - "4096"
      - --dtype
      - bfloat16
      - --gpu-memory-utilization
      - "0.70"
      - --max-num-seqs
      - "4"
      - --port
      - "8000"
      - --host
      - "0.0.0.0"
    ports:
      - "18080:8000"
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:8000/v1/models"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 60s
    restart: unless-stopped

  # ========== FastAPI 백엔드 ==========
  fastapi:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: library-fastapi
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    volumes:
      - ..:/app
      - ../models/.hf-cache:/models
    <<: *ragnet
    environment:
      IS_DOCKER: "true"
      PYTHONUNBUFFERED: "1"
      CUDA_VISIBLE_DEVICES: "0"

      MINIO_ENDPOINT: "minio:9000"
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY:-minioadmin}
      MINIO_SECURE: "false"
      MINIO_BUCKET: "library-bucket"

      MILVUS_HOST: "milvus"
      MILVUS_PORT: "19530"
      MILVUS_COLLECTION: "library_books"
      MILVUS_CONNECT_TIMEOUT: "60"
      MILVUS_CONNECT_RETRIES: "10"
      MILVUS_CONNECT_BACKOFF: "1.0"

      VLLM_BASE_URL: "http://vllm-a4000:8000"

      RAG_TARGET_TOKENS: "512"
      RAG_OVERLAP_TOKENS: "64"
      RAG_MIN_CHUNK_TOKENS: "100"
      RAG_TOPK_INIT: "40"
      RAG_SCORE_THRESHOLD: "0.3"
      RAG_CONTEXT_BUDGET_TOKENS: "2048"
      RAG_USE_HYBRID: "1"
      RAG_HYBRID_WEIGHT_VEC: "0.7"

      EMBEDDING_MODEL_NAME: "BAAI/bge-m3"
      EMBEDDING_BATCH_SIZE: "32"
      EMBEDDING_MAX_LENGTH: "512"

      RERANKER_MODEL_NAME: "BAAI/bge-reranker-v2-m3"
      RERANKER_BATCH_SIZE: "16"
    depends_on:
      vllm-a4000:
        condition: service_healthy
      milvus:
        condition: service_healthy
      minio:
        condition: service_healthy
    ports:
      - "8000:8000"
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 60s
    restart: unless-stopped

  # ========== Nuxt.js 프론트엔드 ==========
  nuxt:
    build:
      context: ..
      dockerfile: docker/Dockerfile.nuxt
    container_name: library-nuxt
    volumes:
      - ../frontend:/app
    environment:
      NUXT_PUBLIC_API_BASE: "/api"
      NITRO_HOST: "0.0.0.0"
      NITRO_PORT: "3000"
      PORT: "3000"
    <<: *ragnet
    depends_on:
      fastapi:
        condition: service_healthy
    restart: unless-stopped

  # ========== Nginx 게이트웨이 ==========
  gateway:
    image: nginx:alpine
    container_name: library-gateway
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
    ports:
      - "90:80"
    <<: *ragnet
    depends_on:
      nuxt:
        condition: service_started
      fastapi:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/health"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 20s
    restart: unless-stopped

# ========== 볼륨 정의 (External) ==========
volumes:
  library_etcd_data:
    external: true
    name: library_etcd_data
  library_milvus_data:
    external: true
    name: library_milvus_data
  library_minio_data:
    external: true
    name: library_minio_data

# ========== 네트워크 정의 (External) ==========
networks:
  library-ragnet:
    external: true
    name: library-ragnet
